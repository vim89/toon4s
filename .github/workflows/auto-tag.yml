# Auto Tag - Automated semantic versioning based on conventional commits
# Uses mathieudutour/github-tag-action for proven, reliable tagging
#
# Triggers:
#   - Push to main branch (NO paths-ignore to ensure ALL changes trigger releases)
#   - Can be skipped with [skip ci] or [skip release] in commit message
#
# How it works:
#   1. Analyzes commits since last tag using conventional commits
#   2. Determines version bump (major/minor/patch) automatically
#   3. Creates and pushes new tag if version changed
#   4. Triggers release.yml and changelog.yml workflows via tag push
#
# Conventional Commits:
#   - feat: triggers MINOR version bump (0.1.0 -> 0.2.0)
#   - fix: triggers PATCH version bump (0.1.0 -> 0.1.1)
#   - feat!/fix! or BREAKING CHANGE: triggers MAJOR bump (0.1.0 -> 1.0.0)
#   - chore/docs/test/refactor/ci/build: triggers PATCH bump
#
# Edge cases handled:
#   - First tag starts at v0.1.0
#   - No version bump if no relevant commits
#   - Tag already exists: skips gracefully
#   - Multiple commits: uses highest bump type
#   - Workflow changes: WILL trigger release (no paths-ignore)

name: Auto Tag

on:
  push:
    branches: [main]

concurrency:
  group: auto-tag-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: write

jobs:
  auto-tag:
    name: Create semantic version tag
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[skip release]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required: fetch full history for tag analysis
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          tag_prefix: v
          release_branches: main
          # Custom release rules for conventional commits
          custom_release_rules: |
            feat:minor:Features,
            fix:patch:Bug Fixes,
            docs:patch:Documentation,
            chore:patch:Chores,
            refactor:patch:Refactoring,
            perf:patch:Performance,
            test:patch:Tests,
            build:patch:Build System,
            ci:patch:CI/CD,
            revert:patch:Reverts

      - name: Trigger Release Workflow
        if: steps.tag_version.outputs.new_tag != ''
        env:
          NEW_TAG: ${{ steps.tag_version.outputs.new_tag }}
          PREV_TAG: ${{ steps.tag_version.outputs.previous_tag }}
        uses: actions/github-script@v7
        with:
          script: |
            // Only trigger release workflow
            // Changelog will run after release completes successfully
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'release-tag-created',
              client_payload: {
                tag: process.env.NEW_TAG,
                previous_tag: process.env.PREV_TAG
              }
            });

      - name: Summary
        if: steps.tag_version.outputs.new_tag != ''
        run: |
          echo "## Tag Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Tag**: \`${{ steps.tag_version.outputs.new_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Tag**: \`${{ steps.tag_version.outputs.previous_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version Bump**: \`${{ steps.tag_version.outputs.part }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changelog**:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.tag_version.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Release and Changelog workflows triggered" >> $GITHUB_STEP_SUMMARY

      - name: No tag created
        if: steps.tag_version.outputs.new_tag == ''
        run: |
          echo "## No Tag Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No version bump needed based on commit messages" >> $GITHUB_STEP_SUMMARY
