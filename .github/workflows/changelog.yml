# Changelog - Automated changelog generation from conventional commits
# Uses git-cliff for conventional commits -> changelog conversion
#
# Triggers:
#   - After successful release completion (via repository_dispatch)
#   - Manual trigger via workflow_dispatch
#
# How it works:
#   1. Runs AFTER release completes successfully
#   2. Generates changelog entry for the new version
#   3. Commits and pushes CHANGELOG.md back to main
#   4. Auto-syncs all open PR branches with main
#   5. Uses [skip ci] to prevent infinite loops
#
# Edge cases handled:
#   - First release: generates full changelog
#   - No changes: skips commit if changelog unchanged
#   - Concurrent runs: uses concurrency group
#   - Skip ci commits: ignored by cliff.toml config
#   - No open PRs: skips sync step gracefully

name: Changelog

on:
  repository_dispatch:
    types: [release-completed]
  workflow_dispatch:

concurrency:
  group: changelog-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write  # For syncing PR branches with main

jobs:
  changelog:
    name: Generate changelog
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for full git history
          ref: main  # Always update changelog on main branch

      - name: Install git-cliff
        run: |
          curl -fsSL https://github.com/orhun/git-cliff/releases/download/v2.4.0/git-cliff-2.4.0-x86_64-unknown-linux-gnu.tar.gz -o git-cliff.tar.gz
          tar -xzf git-cliff.tar.gz
          sudo mv git-cliff-*/git-cliff /usr/local/bin/
          git-cliff --version

      - name: Generate full changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Generate changelog for all versions (from all tags)
          # GITHUB_TOKEN enables fetching PR numbers and metadata
          git-cliff --config cliff.toml --verbose -o CHANGELOG.md

      - name: Commit and push changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet CHANGELOG.md; then
            echo "No changes to changelog"
            exit 0
          fi

          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG.md for ${{ github.ref_name }} [skip ci]"
          git push origin main

      - name: Auto-sync open PR branches with main
        uses: actions/github-script@v7
        with:
          script: |
            // Get all open PRs
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            if (pulls.length === 0) {
              console.log('No open PRs to sync');
              return;
            }

            console.log(`Found ${pulls.length} open PR(s) to sync with main`);

            for (const pr of pulls) {
              // Skip PRs from forks (can't update them directly)
              if (pr.head.repo.full_name !== pr.base.repo.full_name) {
                console.log(`⏭ Skipping PR #${pr.number} (from fork: ${pr.head.repo.full_name})`);
                continue;
              }

              try {
                // Update branch by merging main into it
                await github.rest.repos.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  base: pr.head.ref,
                  head: 'main',
                  commit_message: `chore: sync with main [skip ci]`
                });
                console.log(`✓ Synced PR #${pr.number}: ${pr.title}`);
              } catch (error) {
                if (error.status === 409) {
                  console.log(`ℹ PR #${pr.number} already up to date or has conflicts`);
                } else if (error.status === 204) {
                  console.log(`ℹ PR #${pr.number} already up to date`);
                } else {
                  console.log(`⚠ Could not sync PR #${pr.number}: ${error.message}`);
                }
              }
            }

      - name: Summary
        run: |
          echo "## Changelog Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changelog has been updated and committed to main branch" >> $GITHUB_STEP_SUMMARY
          echo "All open PR branches have been synced with main" >> $GITHUB_STEP_SUMMARY
