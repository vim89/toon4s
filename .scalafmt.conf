# Scalafmt configuration for toon4s
# Formatting that prioritizes readability, consistency, and minimal diff noise

version = 3.10.1

# ==============================================================================
# Runner & dialect configuration
# ==============================================================================

runner.dialect = scala3

# Enable Scala 3 specific features
runner.dialectOverride.allowEndMarker = true
runner.dialectOverride.allowToplevelTerms = true
runner.dialectOverride.allowSignificantIndentation = true

# ==============================================================================
# Line length & formatting
# ==============================================================================

# 100 columns balances readability and screen real estate
maxColumn = 100

# ==============================================================================
# Indentation settings
# ==============================================================================

indent.main = 2
indent.callSite = 2
indent.defnSite = 4           # Double indent for definition parameters
indent.significant = 2        # For Scala 3 optional braces / significant indentation
indent.ctorSite = 4           # Constructor parameters
indent.ctrlSite = 4           # if/while/for control structures
indent.caseSite = 4           # case clauses
indent.matchSite = 0          # match keyword itself
indent.extendSite = 4         # extends/derives clauses

# ==============================================================================
# Alignment strategy
# ==============================================================================

# Use "more" instead of "most" to balance aesthetics with minimal diff noise
# "most" can cause large diffs when renaming, "more" is a pragmatic middle ground
align.preset = more
align.multiline = false        # Avoid multi-line alignment for cleaner diffs
align.stripMargin = true       # Align stripMargin pipes
align.arrowEnumeratorGenerator = false  # Disable <- alignment in for-comprehensions
align.tokens = [              # Explicit token alignment control
  {code = "=>", owner = "Case"},
  {code = "%", owner = "Term.ApplyInfix"},
  {code = "%%", owner = "Term.ApplyInfix"}
]

# ==============================================================================
# Newlines & spacing
# ==============================================================================

newlines.beforeCurlyLambdaParams = multilineWithCaseOnly
newlines.afterCurlyLambdaParams = squash
newlines.implicitParamListModifierPrefer = before
newlines.sometimesBeforeColonInMethodReturnType = false

# Control blank lines
newlines.source = keep              # Preserve source formatting for blank lines
newlines.topLevelStatementBlankLines = [
  {
    blanks = 1
    minBreaks = 0
    regex = "."
  }
]

# ==============================================================================
# Docstrings
# ==============================================================================

docstrings.style = Asterisk    # Scaladoc style with asterisks
docstrings.wrap = yes          # Wrap long docstring lines
docstrings.oneline = fold      # Keep one-liners compact

# ==============================================================================
# Rewrite rules
# ==============================================================================

rewrite.rules = [
  RedundantBraces,
  RedundantParens,
  SortModifiers,
  PreferCurlyFors,
  Imports
]

# Scala 3 syntax rewrites
# IMPORTANT: Keep disabled to maintain Scala 2.13 compatibility
# The codebase uses common syntax that compiles on both 2.13 and 3.3
rewrite.scala3.convertToNewSyntax = false
rewrite.scala3.removeOptionalBraces = false

# Import formatting
rewrite.imports.sort = scalastyle
rewrite.imports.groups = [
  ["java\\..*"],
  ["scala\\..*"],
  [".*"]
]

# Redundant braces/parens control
rewrite.redundantBraces.methodBodies = false  # Keep method body braces
rewrite.redundantBraces.includeUnitMethods = false
rewrite.redundantBraces.stringInterpolation = true
rewrite.redundantBraces.generalExpressions = false

# ==============================================================================
# Trailing commas
# ==============================================================================

trailingCommas = multiple       # Add trailing commas for multi-line args (minimal diffs)

# ==============================================================================
# Literals & special cases
# ==============================================================================

literals.long = Upper           # Use 123L instead of 123l
literals.float = Upper          # Use 1.0F instead of 1.0f
literals.double = Upper         # Use 1.0D instead of 1.0d
literals.hexDigits = Upper      # Use 0xABC instead of 0xabc

# Strip margin handling
assumeStandardLibraryStripMargin = true

# ==============================================================================
# Comments
# ==============================================================================

comments.wrap = standalone      # Wrap standalone comments
comments.wrapStandaloneSlcAsSlc = true

# ==============================================================================
# Project & git integration
# ==============================================================================

project.git = true              # Use git to determine which files to format
project.includePaths = [
  "glob:**.scala",
  "glob:**.sbt",
  "glob:**.sc"
]

# ==============================================================================
# Vertical multiline settings
# ==============================================================================

verticalMultiline.atDefnSite = false
verticalMultiline.arityThreshold = 100
verticalMultiline.newlineAfterOpenParen = false

# ==============================================================================
# Spaces
# ==============================================================================

spaces.beforeContextBoundColon = Never  # A[T: Eq] not A[T : Eq]
spaces.afterTripleEquals = false
spaces.inImportCurlyBraces = false     # import {A, B} not import { A, B }
spaces.inParentheses = false

# ==============================================================================
# Other modern practices
# ==============================================================================

# Avoid reformatting specific sections if needed
# Use // format: off and // format: on comments
optIn.configStyleArguments = true     # Force config-style for many args
optIn.breakChainOnFirstMethodDot = false
optIn.breaksInsideChains = false

# Encoding
encoding = "UTF-8"

# Include/exclude patterns (can be customized per project)
fileOverride {
  "glob:**/scala-3/**/*.scala" {
    runner.dialect = scala3
  }
  "glob:**/scala-2.13/**/*.scala" {
    runner.dialect = scala213
  }
}
